#!/usr/bin/lua

local crc = require "crc16"
local uci = require "uci"
local util = require "util"
local argv = arg
local x = uci.cursor()

local function neigh_batadv()
	local c = io.popen("batctl o")
	local s = assert(x:get("wbm", "wireless", "ssid"))

	c:read("*l")
	c:read("*l")

	local l
	while true do
		l = c:read("*l")
		if not l then
			break
		end

		local q, a, i = l:match("^%S+ +%S+ +%((%d+)%) +(%S+) +%[ -(%S+)%]")
		if not (q and a and i) then
			break
		end

		local id = crc.hash(a)
		return util.sprintf("%17s	%6.2f%%	%8s	%s-%04x",			a, q / 255 * 100, i, s, id)
	end
end

function orig_bmx6()
	local nodes = util.lines(
		util.exec('bmx6 -c --originators | awk \'{print  $3}\' | grep -e ".*:.*:"'))
	return nodes
end

function neigh_bmx6()
	local nodes = util.lines(util.exec(
		'bmx6 -c --links | awk \'{print $2}\' |  grep -e ".*:.*:"'))
	return nodes
end


-- EXPERIMENTS
 
local function list_neighbours(proto)
	local neighbours = {}
	if proto == "batadv" then neighbours = neigh_batadv() end
	if proto == "bmx6" then neighbours = neigh_bmx6() end
	util.printable(neighbours)	
end

local function list_originators(proto)
	local originators = {}
	if proto == "batadv" then originators = orig_batadv() end
	if proto == "bmx6" then originators = orig_bmx6() end
	util.printable(originators)	
end

local function traceroute(dest)
	print(util.exec('mtr ' .. dest .. ' --report-cycles=3 --raw'))
end

local function ping6(dest, interface)
	print(util.exec('ping6 -c 3 ' .. dest .. ' -I ' .. interface))
end

local function top()
	print(util.exec('top -b -n 1'))
end

-- MAIN

local function main()
	if argv[1] == "list" then
	  if argv[2] == "neighbours" then list_neighbours(argv[3]) end
	  if argv[2] == "originators" then list_originators(argv[3]) end
	end

	if argv[1] == "trace" then traceroute(argv[2]) end
	if argv[1] == "ping6" then ping6(argv[2], argv[3]) end
	if argv[1] == "top" then top() end
		

end

main()

